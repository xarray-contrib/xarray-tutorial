
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Applying unvectorized functions</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/announcement.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="map_blocks" href="../map_blocks/map_blocks.html" />
    <link rel="prev" title="Handling dask arrays" href="simple_dask_apply_ufunc.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JRQHYVFQR7"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-JRQHYVFQR7');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../overview/get-started.html">
   Get Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../overview/xarray-in-45-min.html">
   Xarray in 45 minutes
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Fundamentals
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../fundamentals/01_data_structures.html">
   Data Structures
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/01_datastructures.html">
     Xarray’s Data structures
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/01.1_creating_data_structures.html">
     Creating Data Structures
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/01.1_io.html">
     Reading and writing files
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../fundamentals/02_labeled_data.html">
   Labeled data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/02.1_working_with_labeled_data.html">
     Working with labeled data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/02.2_manipulating_dimensions.html">
     Manipulating Dimensions (Data Resolution)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../fundamentals/03_computation.html">
   Computation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/03.1_computation_with_xarray.html">
     Basic Computation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/02.3_aligning_data_objects.html">
     Computing with Multiple Objects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/03.2_groupby_with_xarray.html">
     Grouped Computations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/03.3_windowed.html">
     Windowed Computations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/03.4_weighted.html">
     Weighted Reductions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../fundamentals/04.0_plotting.html">
   Plotting and Visualization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/04.1_basic_plotting.html">
     Basic Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/04.2_faceting.html">
     Faceting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fundamentals/04.3_geographic_plotting.html">
     Geography with Cartopy
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Intermediate
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intermediate/01-high-level-computation-patterns.html">
   High-level computational patterns
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../intermediate/xarray_and_dask.html">
   Parallel computing with Dask
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../intermediate/xarray_ecosystem.html">
   A Tour of the Xarray Ecosystem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../intermediate/hvplot.html">
   Interactive plots using hvplot
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../intermediate/cmip6-cloud.html">
   Accessing remote data stored on the cloud
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../data_cleaning/ice_velocity.html">
   Re-organize InSAR ice velocity data
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../parallel-intro.html">
   Parallelizing custom functions
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="apply_ufunc.html">
   apply_ufunc
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="simple_numpy_apply_ufunc.html">
     A gentle introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="simple_dask_apply_ufunc.html">
     Handling dask arrays
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Applying unvectorized functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../map_blocks/map_blocks.html">
   map_blocks
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../map_blocks/simple_map_blocks.html">
     A gentle introduction
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../backends/backends.html">
   Creating new backends
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../backends/1.Backend_without_Lazy_Loading.html">
     Binary data without lazy loading
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../backends/2.Backend_with_Lazy_Loading.html">
     Binary data with lazy loading
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Workshops
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../workshops/scipy2022/README.html">
   SciPy 2022
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../workshops/oceanhackweek2020/README.html">
   Oceanhackweek 2020
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference external" href="https://tutorial.xarray.dev/overview/xarray-in-45-min">
     Xarray in 45 minutes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../workshops/thinking-like-xarray/README.html">
   Thinking like Xarray
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference external" href="https://tutorial.xarray.dev/intermediate/01-high-level-computation-patterns">
     High-level computation patterns
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../workshops/online-tutorial-series/README.html">
   Xarray Online Tutorial
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../workshops/online-tutorial-series/01_xarray_fundamentals.html">
     Xarray Fundamentals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../workshops/online-tutorial-series/02_indexing.html">
     Indexing and Selecting Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../workshops/online-tutorial-series/03_computation.html">
     Computation
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Domain Specific
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://anopheles-genomic-surveillance.github.io/workshop-5/module-1-xarray.html">
   Genomics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://predictablynoisy.com/posts/2019/2019-10-22-xarray-neuro/">
   Electrophysiology
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/resources.html">
   Keep Exploring!
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/glossary.html">
   Glossary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/bibliography.html">
   Bibliography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reference/acknowledgements.html">
   Acknowledgements
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/xarray-contrib/xarray-tutorial"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/xarray-contrib/xarray-tutorial/issues/new?title=Issue%20on%20page%20%2Fadvanced/apply_ufunc/vectorize_1d.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/xarray-contrib/xarray-tutorial/edit/main/advanced/apply_ufunc/vectorize_1d.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/advanced/apply_ufunc/vectorize_1d.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#apply-ufunc">
   <code class="docutils literal notranslate">
    <span class="pre">
     apply_ufunc
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exclude-dims">
   <code class="docutils literal notranslate">
    <span class="pre">
     exclude_dims
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#core-dimensions">
   Core dimensions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vectorization-with-np-vectorize">
   Vectorization with
   <code class="docutils literal notranslate">
    <span class="pre">
     np.vectorize
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelization-with-dask">
   Parallelization with dask
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-performance-vectorization-gufuncs-numba-guvectorize">
   High performance vectorization: gufuncs, numba &amp; guvectorize
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Applying unvectorized functions</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#apply-ufunc">
   <code class="docutils literal notranslate">
    <span class="pre">
     apply_ufunc
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exclude-dims">
   <code class="docutils literal notranslate">
    <span class="pre">
     exclude_dims
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#core-dimensions">
   Core dimensions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vectorization-with-np-vectorize">
   Vectorization with
   <code class="docutils literal notranslate">
    <span class="pre">
     np.vectorize
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelization-with-dask">
   Parallelization with dask
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-performance-vectorization-gufuncs-numba-guvectorize">
   High performance vectorization: gufuncs, numba &amp; guvectorize
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="applying-unvectorized-functions">
<h1>Applying unvectorized functions<a class="headerlink" href="#applying-unvectorized-functions" title="Permalink to this headline">#</a></h1>
<p><strong>Author</strong> <a class="reference external" href="https://cherian.net">Deepak Cherian (NCAR)</a></p>
<p>This example will illustrate how to conveniently apply an unvectorized function <code class="docutils literal notranslate"><span class="pre">func</span></code> to xarray objects using <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code>. <code class="docutils literal notranslate"><span class="pre">func</span></code> expects 1D numpy arrays and returns a 1D numpy array. Our goal is to coveniently apply this function along a dimension of xarray objects that may or may not wrap dask arrays with a signature.</p>
<p>We will illustrate this using <code class="docutils literal notranslate"><span class="pre">np.interp</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Signature: np.interp(x, xp, fp, left=None, right=None, period=None)
Docstring:
    One-dimensional linear interpolation.

Returns the one-dimensional piecewise linear interpolant to a function
with given discrete data points (`xp`, `fp`), evaluated at `x`.
</pre></div>
</div>
<p>and write an <code class="docutils literal notranslate"><span class="pre">xr_interp</span></code> function with signature</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xr_interp(xarray_object, dimension_name, new_coordinate_to_interpolate_to)
</pre></div>
</div>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<p>First lets load an example dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">display_style</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>  <span class="c1"># fancy HTML repr</span>

<span class="n">air</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">tutorial</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">air</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>  <span class="c1"># np.interp needs coordinate in ascending order</span>
    <span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="p">)</span>  <span class="c1"># choose a small subset for convenience</span>
<span class="n">air</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;air&#x27; (time: 4, lat: 25, lon: 3)&gt;
array([[[296.29   , 296.79   , 297.1    ],
        [295.9    , 296.19998, 296.79   ],
        [296.6    , 296.19998, 296.4    ],
        [297.     , 296.69998, 296.1    ],
        [295.4    , 295.69998, 295.79   ],
        [293.79   , 294.1    , 294.6    ],
        [293.1    , 293.29   , 293.29   ],
        [290.19998, 290.79   , 291.4    ],
        [287.9    , 288.     , 288.29   ],
        [286.5    , 286.5    , 285.69998],
        [284.6    , 284.9    , 284.19998],
        [282.79   , 283.19998, 282.6    ],
        [280.     , 280.69998, 280.19998],
        [278.4    , 279.     , 279.     ],
        [277.29   , 277.4    , 277.79   ],
        [276.69998, 277.4    , 277.69998],
        [275.9    , 276.9    , 276.9    ],
        [274.79   , 275.19998, 275.6    ],
        [273.69998, 273.6    , 273.79   ],
        [272.1    , 270.9    , 270.     ],
...
        [293.     , 293.5    , 294.29   ],
        [291.9    , 291.9    , 292.19998],
        [289.19998, 289.4    , 289.9    ],
        [286.6    , 287.1    , 287.9    ],
        [284.79   , 284.79   , 285.4    ],
        [282.79   , 282.     , 282.69998],
        [281.19998, 280.19998, 280.6    ],
        [279.5    , 278.69998, 278.6    ],
        [278.     , 277.69998, 277.6    ],
        [276.4    , 275.9    , 276.4    ],
        [275.6    , 275.69998, 276.1    ],
        [274.5    , 275.6    , 276.29   ],
        [273.4    , 274.5    , 275.5    ],
        [274.1    , 274.     , 273.5    ],
        [273.29   , 272.6    , 271.5    ],
        [272.79   , 272.4    , 271.9    ],
        [267.69998, 266.29   , 264.4    ],
        [256.6    , 254.7    , 252.09999],
        [246.29999, 245.29999, 244.2    ],
        [241.89   , 241.79999, 241.79999]]], dtype=float32)
Coordinates:
  * lat      (lat) float32 15.0 17.5 20.0 22.5 25.0 ... 65.0 67.5 70.0 72.5 75.0
  * lon      (lon) float32 200.0 202.5 205.0
  * time     (time) datetime64[ns] 2013-01-01 ... 2013-01-01T18:00:00
Attributes:
    long_name:     4xDaily Air temperature at sigma level 995
    units:         degK
    precision:     2
    GRIB_id:       11
    GRIB_name:     TMP
    var_desc:      Air temperature
    dataset:       NMC Reanalysis
    level_desc:    Surface
    statistic:     Individual Obs
    parent_stat:   Other
    actual_range:  [185.16 322.1 ]</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'air'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 4</li><li><span class='xr-has-index'>lat</span>: 25</li><li><span class='xr-has-index'>lon</span>: 3</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-aefc1b3e-9104-4775-86e7-929a85d94e3f' class='xr-array-in' type='checkbox' checked><label for='section-aefc1b3e-9104-4775-86e7-929a85d94e3f' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>296.3 296.8 297.1 295.9 296.2 296.8 ... 245.3 244.2 241.9 241.8 241.8</span></div><div class='xr-array-data'><pre>array([[[296.29   , 296.79   , 297.1    ],
        [295.9    , 296.19998, 296.79   ],
        [296.6    , 296.19998, 296.4    ],
        [297.     , 296.69998, 296.1    ],
        [295.4    , 295.69998, 295.79   ],
        [293.79   , 294.1    , 294.6    ],
        [293.1    , 293.29   , 293.29   ],
        [290.19998, 290.79   , 291.4    ],
        [287.9    , 288.     , 288.29   ],
        [286.5    , 286.5    , 285.69998],
        [284.6    , 284.9    , 284.19998],
        [282.79   , 283.19998, 282.6    ],
        [280.     , 280.69998, 280.19998],
        [278.4    , 279.     , 279.     ],
        [277.29   , 277.4    , 277.79   ],
        [276.69998, 277.4    , 277.69998],
        [275.9    , 276.9    , 276.9    ],
        [274.79   , 275.19998, 275.6    ],
        [273.69998, 273.6    , 273.79   ],
        [272.1    , 270.9    , 270.     ],
...
        [293.     , 293.5    , 294.29   ],
        [291.9    , 291.9    , 292.19998],
        [289.19998, 289.4    , 289.9    ],
        [286.6    , 287.1    , 287.9    ],
        [284.79   , 284.79   , 285.4    ],
        [282.79   , 282.     , 282.69998],
        [281.19998, 280.19998, 280.6    ],
        [279.5    , 278.69998, 278.6    ],
        [278.     , 277.69998, 277.6    ],
        [276.4    , 275.9    , 276.4    ],
        [275.6    , 275.69998, 276.1    ],
        [274.5    , 275.6    , 276.29   ],
        [273.4    , 274.5    , 275.5    ],
        [274.1    , 274.     , 273.5    ],
        [273.29   , 272.6    , 271.5    ],
        [272.79   , 272.4    , 271.9    ],
        [267.69998, 266.29   , 264.4    ],
        [256.6    , 254.7    , 252.09999],
        [246.29999, 245.29999, 244.2    ],
        [241.89   , 241.79999, 241.79999]]], dtype=float32)</pre></div></div></li><li class='xr-section-item'><input id='section-1e18fe5b-b3c4-444d-9337-97996b9125ca' class='xr-section-summary-in' type='checkbox'  checked><label for='section-1e18fe5b-b3c4-444d-9337-97996b9125ca' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lat</span></div><div class='xr-var-dims'>(lat)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>15.0 17.5 20.0 ... 70.0 72.5 75.0</div><input id='attrs-9ecf716d-a0ae-4f88-985b-6a4e0b7db4c0' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-9ecf716d-a0ae-4f88-985b-6a4e0b7db4c0' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-2bc6f8ed-c6a9-47e1-9996-af9f421dc70e' class='xr-var-data-in' type='checkbox'><label for='data-2bc6f8ed-c6a9-47e1-9996-af9f421dc70e' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>latitude</dd><dt><span>long_name :</span></dt><dd>Latitude</dd><dt><span>units :</span></dt><dd>degrees_north</dd><dt><span>axis :</span></dt><dd>Y</dd></dl></div><div class='xr-var-data'><pre>array([15. , 17.5, 20. , 22.5, 25. , 27.5, 30. , 32.5, 35. , 37.5, 40. , 42.5,
       45. , 47.5, 50. , 52.5, 55. , 57.5, 60. , 62.5, 65. , 67.5, 70. , 72.5,
       75. ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lon</span></div><div class='xr-var-dims'>(lon)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>200.0 202.5 205.0</div><input id='attrs-926dd27c-a23c-4196-b92f-bc0c10df9b3d' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-926dd27c-a23c-4196-b92f-bc0c10df9b3d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-e6bb56ae-5007-4468-8f2b-d10e4b99efea' class='xr-var-data-in' type='checkbox'><label for='data-e6bb56ae-5007-4468-8f2b-d10e4b99efea' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>longitude</dd><dt><span>long_name :</span></dt><dd>Longitude</dd><dt><span>units :</span></dt><dd>degrees_east</dd><dt><span>axis :</span></dt><dd>X</dd></dl></div><div class='xr-var-data'><pre>array([200. , 202.5, 205. ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2013-01-01 ... 2013-01-01T18:00:00</div><input id='attrs-f1c01e4e-4549-471f-a571-c326d136dd71' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-f1c01e4e-4549-471f-a571-c326d136dd71' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-cadc25a2-ca15-40f1-ac72-6f816c4c68d2' class='xr-var-data-in' type='checkbox'><label for='data-cadc25a2-ca15-40f1-ac72-6f816c4c68d2' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>time</dd><dt><span>long_name :</span></dt><dd>Time</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;2013-01-01T00:00:00.000000000&#x27;, &#x27;2013-01-01T06:00:00.000000000&#x27;,
       &#x27;2013-01-01T12:00:00.000000000&#x27;, &#x27;2013-01-01T18:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-b56c024e-bd3e-4686-bc05-e3f0f7d1c994' class='xr-section-summary-in' type='checkbox'  ><label for='section-b56c024e-bd3e-4686-bc05-e3f0f7d1c994' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>lat</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-93f1ab2a-81ce-45b7-842d-87af90faf12e' class='xr-index-data-in' type='checkbox'/><label for='index-93f1ab2a-81ce-45b7-842d-87af90faf12e' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([15.0, 17.5, 20.0, 22.5, 25.0, 27.5, 30.0, 32.5, 35.0, 37.5, 40.0,
              42.5, 45.0, 47.5, 50.0, 52.5, 55.0, 57.5, 60.0, 62.5, 65.0, 67.5,
              70.0, 72.5, 75.0],
             dtype=&#x27;float64&#x27;, name=&#x27;lat&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>lon</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-444dd896-3af8-453b-a5ee-16df7ca036b5' class='xr-index-data-in' type='checkbox'/><label for='index-444dd896-3af8-453b-a5ee-16df7ca036b5' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([200.0, 202.5, 205.0], dtype=&#x27;float64&#x27;, name=&#x27;lon&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-637a285d-dbe7-4659-90f1-ec0ac3effd74' class='xr-index-data-in' type='checkbox'/><label for='index-637a285d-dbe7-4659-90f1-ec0ac3effd74' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;2013-01-01 00:00:00&#x27;, &#x27;2013-01-01 06:00:00&#x27;,
               &#x27;2013-01-01 12:00:00&#x27;, &#x27;2013-01-01 18:00:00&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, freq=None))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-69c33bbd-3565-44d0-9bf5-483feefc2d25' class='xr-section-summary-in' type='checkbox'  ><label for='section-69c33bbd-3565-44d0-9bf5-483feefc2d25' class='xr-section-summary' >Attributes: <span>(11)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>4xDaily Air temperature at sigma level 995</dd><dt><span>units :</span></dt><dd>degK</dd><dt><span>precision :</span></dt><dd>2</dd><dt><span>GRIB_id :</span></dt><dd>11</dd><dt><span>GRIB_name :</span></dt><dd>TMP</dd><dt><span>var_desc :</span></dt><dd>Air temperature</dd><dt><span>dataset :</span></dt><dd>NMC Reanalysis</dd><dt><span>level_desc :</span></dt><dd>Surface</dd><dt><span>statistic :</span></dt><dd>Individual Obs</dd><dt><span>parent_stat :</span></dt><dd>Other</dd><dt><span>actual_range :</span></dt><dd>[185.16 322.1 ]</dd></dl></div></li></ul></div></div></div></div>
</div>
<p>The function we will apply is <code class="docutils literal notranslate"><span class="pre">np.interp</span></code> which expects 1D numpy arrays. This functionality is already implemented in xarray so we use that capability to make sure we are not making mistakes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">air</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">newlat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;air&#x27; (time: 4, lat: 100, lon: 3)&gt;
array([[[296.29000854, 296.79000854, 297.1000061 ],
        [296.19545954, 296.64697173, 297.02485518],
        [296.10091053, 296.50393491, 296.94970426],
        ...,
        [242.46059851, 243.46969695, 244.08181672],
        [241.83029767, 242.98484846, 243.79090837],
        [241.19999683, 242.49999997, 243.50000003]],

       [[296.29000854, 297.19998169, 297.3999939 ],
        [296.26818385, 297.07876957, 297.25211866],
        [296.24635916, 296.95755744, 297.10424342],
        ...,
        [242.82726354, 243.37878187, 243.63332714],
        [242.46362716, 243.03938941, 243.36665899],
        [242.09999079, 242.69999695, 243.09999084]],

       [[296.3999939 , 296.29000854, 296.3999939 ],
        [296.35150609, 296.34091556, 296.37333078],
        [296.30301828, 296.39182258, 296.34666767],
        ...,
        [243.4151408 , 243.26181628, 243.12423612],
        [242.85756431, 242.73090659, 242.71211194],
        [242.29998782, 242.19999689, 242.29998776]],

       [[297.5       , 297.69998169, 297.5       ],
        [297.37878788, 297.65150128, 297.40303179],
        [297.25757575, 297.60302087, 297.30606357],
        ...,
        [244.02817552, 243.49695752, 242.96362858],
        [242.9590874 , 242.64847269, 242.38180817],
        [241.88999927, 241.79998785, 241.79998776]]])
Coordinates:
  * lon      (lon) float32 200.0 202.5 205.0
  * time     (time) datetime64[ns] 2013-01-01 ... 2013-01-01T18:00:00
  * lat      (lat) float64 15.0 15.61 16.21 16.82 ... 73.18 73.79 74.39 75.0
Attributes:
    long_name:     4xDaily Air temperature at sigma level 995
    units:         degK
    precision:     2
    GRIB_id:       11
    GRIB_name:     TMP
    var_desc:      Air temperature
    dataset:       NMC Reanalysis
    level_desc:    Surface
    statistic:     Individual Obs
    parent_stat:   Other
    actual_range:  [185.16 322.1 ]</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'air'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 4</li><li><span class='xr-has-index'>lat</span>: 100</li><li><span class='xr-has-index'>lon</span>: 3</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-98159406-ee7f-41bd-820c-bf3e7b3b4baf' class='xr-array-in' type='checkbox' checked><label for='section-98159406-ee7f-41bd-820c-bf3e7b3b4baf' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>296.3 296.8 297.1 296.2 296.6 297.0 ... 242.6 242.4 241.9 241.8 241.8</span></div><div class='xr-array-data'><pre>array([[[296.29000854, 296.79000854, 297.1000061 ],
        [296.19545954, 296.64697173, 297.02485518],
        [296.10091053, 296.50393491, 296.94970426],
        ...,
        [242.46059851, 243.46969695, 244.08181672],
        [241.83029767, 242.98484846, 243.79090837],
        [241.19999683, 242.49999997, 243.50000003]],

       [[296.29000854, 297.19998169, 297.3999939 ],
        [296.26818385, 297.07876957, 297.25211866],
        [296.24635916, 296.95755744, 297.10424342],
        ...,
        [242.82726354, 243.37878187, 243.63332714],
        [242.46362716, 243.03938941, 243.36665899],
        [242.09999079, 242.69999695, 243.09999084]],

       [[296.3999939 , 296.29000854, 296.3999939 ],
        [296.35150609, 296.34091556, 296.37333078],
        [296.30301828, 296.39182258, 296.34666767],
        ...,
        [243.4151408 , 243.26181628, 243.12423612],
        [242.85756431, 242.73090659, 242.71211194],
        [242.29998782, 242.19999689, 242.29998776]],

       [[297.5       , 297.69998169, 297.5       ],
        [297.37878788, 297.65150128, 297.40303179],
        [297.25757575, 297.60302087, 297.30606357],
        ...,
        [244.02817552, 243.49695752, 242.96362858],
        [242.9590874 , 242.64847269, 242.38180817],
        [241.88999927, 241.79998785, 241.79998776]]])</pre></div></div></li><li class='xr-section-item'><input id='section-104ea507-6650-4925-8195-8d7571f5a664' class='xr-section-summary-in' type='checkbox'  checked><label for='section-104ea507-6650-4925-8195-8d7571f5a664' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lon</span></div><div class='xr-var-dims'>(lon)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>200.0 202.5 205.0</div><input id='attrs-68b9e824-1655-4e94-9b28-6d40c6bc0f75' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-68b9e824-1655-4e94-9b28-6d40c6bc0f75' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-db15929f-8214-4c99-aa64-ea9b85dc0b2a' class='xr-var-data-in' type='checkbox'><label for='data-db15929f-8214-4c99-aa64-ea9b85dc0b2a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>longitude</dd><dt><span>long_name :</span></dt><dd>Longitude</dd><dt><span>units :</span></dt><dd>degrees_east</dd><dt><span>axis :</span></dt><dd>X</dd></dl></div><div class='xr-var-data'><pre>array([200. , 202.5, 205. ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2013-01-01 ... 2013-01-01T18:00:00</div><input id='attrs-e504d15f-9808-41c1-9fd9-9af70f3b8fd3' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-e504d15f-9808-41c1-9fd9-9af70f3b8fd3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6df2e473-e39f-490f-9dab-bc9ebc09d5f7' class='xr-var-data-in' type='checkbox'><label for='data-6df2e473-e39f-490f-9dab-bc9ebc09d5f7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>time</dd><dt><span>long_name :</span></dt><dd>Time</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;2013-01-01T00:00:00.000000000&#x27;, &#x27;2013-01-01T06:00:00.000000000&#x27;,
       &#x27;2013-01-01T12:00:00.000000000&#x27;, &#x27;2013-01-01T18:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lat</span></div><div class='xr-var-dims'>(lat)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>15.0 15.61 16.21 ... 74.39 75.0</div><input id='attrs-bdef375c-2e14-446d-9d51-ac1e61f0d3d5' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-bdef375c-2e14-446d-9d51-ac1e61f0d3d5' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-3280ad31-ba6f-495f-bf79-d7d50ae3ae57' class='xr-var-data-in' type='checkbox'><label for='data-3280ad31-ba6f-495f-bf79-d7d50ae3ae57' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>latitude</dd><dt><span>long_name :</span></dt><dd>Latitude</dd><dt><span>units :</span></dt><dd>degrees_north</dd><dt><span>axis :</span></dt><dd>Y</dd></dl></div><div class='xr-var-data'><pre>array([15.      , 15.606061, 16.212121, 16.818182, 17.424242, 18.030303,
       18.636364, 19.242424, 19.848485, 20.454545, 21.060606, 21.666667,
       22.272727, 22.878788, 23.484848, 24.090909, 24.69697 , 25.30303 ,
       25.909091, 26.515152, 27.121212, 27.727273, 28.333333, 28.939394,
       29.545455, 30.151515, 30.757576, 31.363636, 31.969697, 32.575758,
       33.181818, 33.787879, 34.393939, 35.      , 35.606061, 36.212121,
       36.818182, 37.424242, 38.030303, 38.636364, 39.242424, 39.848485,
       40.454545, 41.060606, 41.666667, 42.272727, 42.878788, 43.484848,
       44.090909, 44.69697 , 45.30303 , 45.909091, 46.515152, 47.121212,
       47.727273, 48.333333, 48.939394, 49.545455, 50.151515, 50.757576,
       51.363636, 51.969697, 52.575758, 53.181818, 53.787879, 54.393939,
       55.      , 55.606061, 56.212121, 56.818182, 57.424242, 58.030303,
       58.636364, 59.242424, 59.848485, 60.454545, 61.060606, 61.666667,
       62.272727, 62.878788, 63.484848, 64.090909, 64.69697 , 65.30303 ,
       65.909091, 66.515152, 67.121212, 67.727273, 68.333333, 68.939394,
       69.545455, 70.151515, 70.757576, 71.363636, 71.969697, 72.575758,
       73.181818, 73.787879, 74.393939, 75.      ])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-8a298edb-e380-46f0-8ccc-3986b0853258' class='xr-section-summary-in' type='checkbox'  ><label for='section-8a298edb-e380-46f0-8ccc-3986b0853258' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>lon</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-34cedb8b-ab92-485b-b102-fea515dc27d4' class='xr-index-data-in' type='checkbox'/><label for='index-34cedb8b-ab92-485b-b102-fea515dc27d4' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([200.0, 202.5, 205.0], dtype=&#x27;float64&#x27;, name=&#x27;lon&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-b12d48f9-a4ce-4f0c-9c31-be37aa644d80' class='xr-index-data-in' type='checkbox'/><label for='index-b12d48f9-a4ce-4f0c-9c31-be37aa644d80' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;2013-01-01 00:00:00&#x27;, &#x27;2013-01-01 06:00:00&#x27;,
               &#x27;2013-01-01 12:00:00&#x27;, &#x27;2013-01-01 18:00:00&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, freq=None))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>lat</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-ebec635c-4190-48b0-9540-56b158a9abe3' class='xr-index-data-in' type='checkbox'/><label for='index-ebec635c-4190-48b0-9540-56b158a9abe3' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([              15.0, 15.606060606060606,  16.21212121212121,
               16.81818181818182, 17.424242424242426,  18.03030303030303,
              18.636363636363637, 19.242424242424242, 19.848484848484848,
              20.454545454545453, 21.060606060606062, 21.666666666666668,
              22.272727272727273,  22.87878787878788, 23.484848484848484,
              24.090909090909093, 24.696969696969695, 25.303030303030305,
               25.90909090909091, 26.515151515151516,  27.12121212121212,
              27.727272727272727, 28.333333333333336, 28.939393939393938,
              29.545454545454547, 30.151515151515152, 30.757575757575758,
              31.363636363636363,  31.96969696969697,  32.57575757575758,
               33.18181818181819,  33.78787878787879,  34.39393939393939,
                            35.0,  35.60606060606061,  36.21212121212121,
               36.81818181818182,  37.42424242424242,  38.03030303030303,
               38.63636363636364,  39.24242424242424, 39.848484848484844,
               40.45454545454545,  41.06060606060606,  41.66666666666667,
               42.27272727272727, 42.878787878787875, 43.484848484848484,
               44.09090909090909,   44.6969696969697, 45.303030303030305,
               45.90909090909091, 46.515151515151516, 47.121212121212125,
               47.72727272727273, 48.333333333333336,  48.93939393939394,
               49.54545454545455, 50.151515151515156,  50.75757575757576,
               51.36363636363637,  51.96969696969697,  52.57575757575758,
               53.18181818181818,  53.78787878787879,   54.3939393939394,
                            55.0,  55.60606060606061,  56.21212121212121,
               56.81818181818182,  57.42424242424242,  58.03030303030303,
               58.63636363636364,  59.24242424242424,  59.84848484848485,
               60.45454545454545,  61.06060606060606,  61.66666666666667,
               62.27272727272727,  62.87878787878788, 63.484848484848484,
                64.0909090909091,  64.69696969696969,  65.30303030303031,
                65.9090909090909,  66.51515151515152,  67.12121212121212,
               67.72727272727272,  68.33333333333334,  68.93939393939394,
               69.54545454545455,  70.15151515151516,  70.75757575757575,
               71.36363636363637,  71.96969696969697,  72.57575757575758,
               73.18181818181819,  73.78787878787878,   74.3939393939394,
                            75.0],
             dtype=&#x27;float64&#x27;, name=&#x27;lat&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-6274eaed-a97a-4778-bed1-12397067591f' class='xr-section-summary-in' type='checkbox'  ><label for='section-6274eaed-a97a-4778-bed1-12397067591f' class='xr-section-summary' >Attributes: <span>(11)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>4xDaily Air temperature at sigma level 995</dd><dt><span>units :</span></dt><dd>degK</dd><dt><span>precision :</span></dt><dd>2</dd><dt><span>GRIB_id :</span></dt><dd>11</dd><dt><span>GRIB_name :</span></dt><dd>TMP</dd><dt><span>var_desc :</span></dt><dd>Air temperature</dd><dt><span>dataset :</span></dt><dd>NMC Reanalysis</dd><dt><span>level_desc :</span></dt><dd>Surface</dd><dt><span>statistic :</span></dt><dd>Individual Obs</dd><dt><span>parent_stat :</span></dt><dd>Other</dd><dt><span>actual_range :</span></dt><dd>[185.16 322.1 ]</dd></dl></div></li></ul></div></div></div></div>
</div>
<p>Let’s define a function that works with one vector of data along <code class="docutils literal notranslate"><span class="pre">lat</span></code> at a time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp1d_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="n">interped</span> <span class="o">=</span> <span class="n">interp1d_np</span><span class="p">(</span><span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">newlat</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">air</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">newlat</span><span class="p">)</span>

<span class="c1"># no errors are raised if values are equal to within floating point precision</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">interped</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>No errors are raised so our interpolation is working.</p>
<p>This function consumes and returns numpy arrays, which means we need to do a lot of work to convert the result back to an xarray object with meaningful metadata. This is where <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> is very useful.</p>
</section>
<section id="apply-ufunc">
<h2><code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code><a class="headerlink" href="#apply-ufunc" title="Permalink to this headline">#</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Apply a vectorized function for unlabeled arrays on xarray objects.

The function will be mapped over the data variable(s) of the input arguments using 
xarray’s standard rules for labeled computation, including alignment, broadcasting, 
looping over GroupBy/Dataset variables, and merging of coordinates.
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> has many capabilities but for simplicity this example will focus on the common task of vectorizing 1D functions over nD xarray objects. We will iteratively build up the right set of arguments to <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> and read through many error messages in doing so.</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
    <span class="n">newlat</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">newlat</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="p">)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:1204,</span> in <span class="ni">apply_ufunc</span><span class="nt">(func, input_core_dims, output_core_dims, exclude_dims, vectorize, join, dataset_join, dataset_fill_value, keep_attrs, kwargs, dask, output_dtypes, output_sizes, meta, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span> <span class="c1"># feed DataArray apply_variable_ufunc through apply_dataarray_vfunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1203</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1204</span>     <span class="k">return</span> <span class="n">apply_dataarray_vfunc</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span>         <span class="n">variables_vfunc</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1206</span>         <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1207</span>         <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1208</span>         <span class="n">join</span><span class="o">=</span><span class="n">join</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1209</span>         <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1210</span>         <span class="n">keep_attrs</span><span class="o">=</span><span class="n">keep_attrs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1212</span> <span class="c1"># feed Variables directly through apply_variable_ufunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:315,</span> in <span class="ni">apply_dataarray_vfunc</span><span class="nt">(func, signature, join, exclude_dims, keep_attrs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> <span class="n">result_coords</span><span class="p">,</span> <span class="n">result_indexes</span> <span class="o">=</span> <span class="n">build_output_coords_and_indexes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="n">args</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="p">,</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="n">keep_attrs</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span> <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">315</span> <span class="n">result_var</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">data_vars</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span> <span class="n">out</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="n">DataArray</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span> <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:805,</span> in <span class="ni">apply_variable_ufunc</span><span class="nt">(func, signature, exclude_dims, dask, output_dtypes, vectorize, keep_attrs, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">803</span> <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">new_size</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">804</span>     <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dim_sizes</span> <span class="ow">and</span> <span class="n">new_size</span> <span class="o">!=</span> <span class="n">dim_sizes</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
<span class="ne">--&gt; </span><span class="mi">805</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">806</span>             <span class="s2">&quot;size of dimension </span><span class="si">{!r}</span><span class="s2"> on inputs was unexpectedly &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">807</span>             <span class="s2">&quot;changed by applied function from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">. Only &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">808</span>             <span class="s2">&quot;dimensions specified in ``exclude_dims`` with &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">809</span>             <span class="s2">&quot;xarray.apply_ufunc are allowed to change size.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">810</span>                 <span class="n">dim</span><span class="p">,</span> <span class="n">dim_sizes</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">new_size</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>             <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span> <span class="n">var</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span> <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

<span class="ne">ValueError</span>: size of dimension &#39;lat&#39; on inputs was unexpectedly changed by applied function from 25 to 100. Only dimensions specified in ``exclude_dims`` with xarray.apply_ufunc are allowed to change size.
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> needs to know a lot of information about what our function does so that it can reconstruct the outputs. In this case, the size of dimension lat has changed and we need to explicitly specify that this will happen. xarray helpfully tells us that we need to specify the kwarg <code class="docutils literal notranslate"><span class="pre">exclude_dims</span></code>.</p>
</section>
<section id="exclude-dims">
<h2><code class="docutils literal notranslate"><span class="pre">exclude_dims</span></code><a class="headerlink" href="#exclude-dims" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>exclude_dims : set, optional
        Core dimensions on the inputs to exclude from alignment and
        broadcasting entirely. Any input coordinates along these dimensions
        will be dropped. Each excluded dimension must also appear in
        ``input_core_dims`` for at least one argument. Only dimensions listed
        here are allowed to change size between input and output objects.
</pre></div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
    <span class="n">newlat</span><span class="p">,</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">newlat</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="p">)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:1120,</span> in <span class="ni">apply_ufunc</span><span class="nt">(func, input_core_dims, output_core_dims, exclude_dims, vectorize, join, dataset_join, dataset_fill_value, keep_attrs, kwargs, dask, output_dtypes, output_sizes, meta, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1116</span>         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1117</span>             <span class="sa">f</span><span class="s2">&quot;Expected exclude_dims to be a &#39;set&#39;. Received &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exclude_dims</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1118</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1119</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude_dims</span> <span class="o">&lt;=</span> <span class="n">signature</span><span class="o">.</span><span class="n">all_core_dims</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1120</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1121</span>             <span class="sa">f</span><span class="s2">&quot;each dimension in `exclude_dims` must also be a &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1122</span>             <span class="sa">f</span><span class="s2">&quot;core dimension in the function signature. &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1123</span>             <span class="sa">f</span><span class="s2">&quot;Please make </span><span class="si">{</span><span class="p">(</span><span class="n">exclude_dims</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">signature</span><span class="o">.</span><span class="n">all_core_dims</span><span class="p">)</span><span class="si">}</span><span class="s2"> a core dimension&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1124</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1126</span> <span class="c1"># handle dask_gufunc_kwargs</span>
<span class="g g-Whitespace">   </span><span class="mi">1127</span> <span class="k">if</span> <span class="n">dask</span> <span class="o">==</span> <span class="s2">&quot;parallelized&quot;</span><span class="p">:</span>

<span class="ne">ValueError</span>: each dimension in `exclude_dims` must also be a core dimension in the function signature. Please make {&#39;lat&#39;} a core dimension
</pre></div>
</div>
</div>
</div>
</section>
<section id="core-dimensions">
<h2>Core dimensions<a class="headerlink" href="#core-dimensions" title="Permalink to this headline">#</a></h2>
<p>Core dimensions are central to using <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code>. In our case, our function expects to receive a 1D vector along <code class="docutils literal notranslate"><span class="pre">lat</span></code> — this is the dimension that is “core” to the function’s functionality. Multiple core dimensions are possible. <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> needs to know which dimensions of each variable are core dimensions.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input_core_dims : Sequence[Sequence], optional
    List of the same length as ``args`` giving the list of core dimensions
    on each input argument that should not be broadcast. By default, we
    assume there are no core dimensions on any input arguments.

    For example, ``input_core_dims=[[], [&#39;time&#39;]]`` indicates that all
    dimensions on the first argument and all dimensions other than &#39;time&#39;
    on the second argument should be broadcast.

    Core dimensions are automatically moved to the last axes of input
    variables before applying ``func``, which facilitates using NumPy style
    generalized ufuncs [2]_.
    
output_core_dims : List[tuple], optional
    List of the same length as the number of output arguments from
    ``func``, giving the list of core dimensions on each output that were
    not broadcast on the inputs. By default, we assume that ``func``
    outputs exactly one array, with axes corresponding to each broadcast
    dimension.

    Core dimensions are assumed to appear as the last dimensions of each
    output in the provided order.
</pre></div>
</div>
<p>Next we specify <code class="docutils literal notranslate"><span class="pre">&quot;lat&quot;</span></code> as <code class="docutils literal notranslate"><span class="pre">input_core_dims</span></code> on both <code class="docutils literal notranslate"><span class="pre">air</span></code> and <code class="docutils literal notranslate"><span class="pre">air.lat</span></code></p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
    <span class="n">newlat</span><span class="p">,</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">newlat</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="p">)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:1204,</span> in <span class="ni">apply_ufunc</span><span class="nt">(func, input_core_dims, output_core_dims, exclude_dims, vectorize, join, dataset_join, dataset_fill_value, keep_attrs, kwargs, dask, output_dtypes, output_sizes, meta, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span> <span class="c1"># feed DataArray apply_variable_ufunc through apply_dataarray_vfunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1203</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1204</span>     <span class="k">return</span> <span class="n">apply_dataarray_vfunc</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span>         <span class="n">variables_vfunc</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1206</span>         <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1207</span>         <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1208</span>         <span class="n">join</span><span class="o">=</span><span class="n">join</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1209</span>         <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1210</span>         <span class="n">keep_attrs</span><span class="o">=</span><span class="n">keep_attrs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1212</span> <span class="c1"># feed Variables directly through apply_variable_ufunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:315,</span> in <span class="ni">apply_dataarray_vfunc</span><span class="nt">(func, signature, join, exclude_dims, keep_attrs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> <span class="n">result_coords</span><span class="p">,</span> <span class="n">result_indexes</span> <span class="o">=</span> <span class="n">build_output_coords_and_indexes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="n">args</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="p">,</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="n">keep_attrs</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span> <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">315</span> <span class="n">result_var</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">data_vars</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span> <span class="n">out</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="n">DataArray</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span> <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:796,</span> in <span class="ni">apply_variable_ufunc</span><span class="nt">(func, signature, exclude_dims, dask, output_dtypes, vectorize, keep_attrs, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">794</span> <span class="n">data</span> <span class="o">=</span> <span class="n">as_compatible_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">795</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">796</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">797</span>         <span class="s2">&quot;applied function returned data with unexpected &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">798</span>         <span class="sa">f</span><span class="s2">&quot;number of dimensions. Received </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2"> dimension(s) but &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">799</span>         <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="si">}</span><span class="s2"> dimensions with names: </span><span class="si">{</span><span class="n">dims</span><span class="si">!r}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">800</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">802</span> <span class="n">var</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fastpath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">803</span> <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">new_size</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="ne">ValueError</span>: applied function returned data with unexpected number of dimensions. Received 1 dimension(s) but expected 0 dimensions with names: ()
</pre></div>
</div>
</div>
</div>
<p>xarray is telling us that it expected to receive back a numpy array with 0 dimensions but instead received an array with 1 dimension corresponding to <code class="docutils literal notranslate"><span class="pre">newlat</span></code>. We can fix this by specifying <code class="docutils literal notranslate"><span class="pre">output_core_dims</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
    <span class="n">newlat</span><span class="p">,</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">]],</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (lat: 100)&gt;
array([296.29000854, 296.19545954, 296.10091053, 296.00636153,
       295.91181252, 296.04848133, 296.21818126, 296.38788119,
       296.55758112, 296.67273227, 296.76970048, 296.8666687 ,
       296.96363692, 296.75757483, 296.36969457, 295.9818143 ,
       295.59393403, 295.20484416, 294.81454468, 294.4242452 ,
       294.03394572, 293.72728105, 293.56000773, 293.39273441,
       293.22546109, 292.92424705, 292.22121083, 291.5181746 ,
       290.81513838, 290.13028509, 289.57271229, 289.01513949,
       288.45756669, 287.8999939 , 287.56060144, 287.22120898,
       286.88181652, 286.54242406, 286.09697099, 285.63636641,
       285.17576183, 284.71515725, 284.27091564, 283.83212835,
       283.39334106, 282.95455378, 282.36727998, 281.69091427,
       281.01454856, 280.33818285, 279.80605987, 279.4181796 ,
       279.03029933, 278.64241906, 278.29908614, 278.02999878,
       277.76091142, 277.49182406, 277.25424934, 277.11121253,
       276.96817571, 276.8251389 , 276.67573964, 276.4818032 ,
       276.28786677, 276.09393033, 275.8999939 , 275.63090654,
       275.36181918, 275.09273182, 274.82364446, 274.55879073,
       274.29454179, 274.03029286, 273.76604392, 273.40907704,
       273.02120417, 272.6333313 , 272.24545843, 272.46364154,
       273.04545824, 273.62727495, 274.20909165, 273.53030303,
       271.59090909, 269.65151515, 267.71212121, 265.        ,
       261.        , 257.        , 253.        , 249.62424168,
       248.12120842, 246.61817516, 245.1151419 , 243.72120019,
       243.09089938, 242.46059857, 241.83029776, 241.19999695])
Coordinates:
    lon      float32 200.0
    time     datetime64[ns] 2013-01-01
Dimensions without coordinates: lat</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span>lat</span>: 100</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-a192005d-5833-47db-b2af-b66889a0062b' class='xr-array-in' type='checkbox' checked><label for='section-a192005d-5833-47db-b2af-b66889a0062b' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>296.3 296.2 296.1 296.0 295.9 296.0 ... 243.7 243.1 242.5 241.8 241.2</span></div><div class='xr-array-data'><pre>array([296.29000854, 296.19545954, 296.10091053, 296.00636153,
       295.91181252, 296.04848133, 296.21818126, 296.38788119,
       296.55758112, 296.67273227, 296.76970048, 296.8666687 ,
       296.96363692, 296.75757483, 296.36969457, 295.9818143 ,
       295.59393403, 295.20484416, 294.81454468, 294.4242452 ,
       294.03394572, 293.72728105, 293.56000773, 293.39273441,
       293.22546109, 292.92424705, 292.22121083, 291.5181746 ,
       290.81513838, 290.13028509, 289.57271229, 289.01513949,
       288.45756669, 287.8999939 , 287.56060144, 287.22120898,
       286.88181652, 286.54242406, 286.09697099, 285.63636641,
       285.17576183, 284.71515725, 284.27091564, 283.83212835,
       283.39334106, 282.95455378, 282.36727998, 281.69091427,
       281.01454856, 280.33818285, 279.80605987, 279.4181796 ,
       279.03029933, 278.64241906, 278.29908614, 278.02999878,
       277.76091142, 277.49182406, 277.25424934, 277.11121253,
       276.96817571, 276.8251389 , 276.67573964, 276.4818032 ,
       276.28786677, 276.09393033, 275.8999939 , 275.63090654,
       275.36181918, 275.09273182, 274.82364446, 274.55879073,
       274.29454179, 274.03029286, 273.76604392, 273.40907704,
       273.02120417, 272.6333313 , 272.24545843, 272.46364154,
       273.04545824, 273.62727495, 274.20909165, 273.53030303,
       271.59090909, 269.65151515, 267.71212121, 265.        ,
       261.        , 257.        , 253.        , 249.62424168,
       248.12120842, 246.61817516, 245.1151419 , 243.72120019,
       243.09089938, 242.46059857, 241.83029776, 241.19999695])</pre></div></div></li><li class='xr-section-item'><input id='section-6d38be81-11e4-47d8-9f17-15570b5b097e' class='xr-section-summary-in' type='checkbox'  checked><label for='section-6d38be81-11e4-47d8-9f17-15570b5b097e' class='xr-section-summary' >Coordinates: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>lon</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>200.0</div><input id='attrs-20f6983f-4370-477b-baa6-b910336fa828' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-20f6983f-4370-477b-baa6-b910336fa828' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6e8bd73f-3452-45aa-8396-8bddf3845176' class='xr-var-data-in' type='checkbox'><label for='data-6e8bd73f-3452-45aa-8396-8bddf3845176' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array(200., dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>time</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2013-01-01</div><input id='attrs-dc1ec91a-48b9-48ca-aad4-fa901765027a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-dc1ec91a-48b9-48ca-aad4-fa901765027a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-eb4751a0-c5e4-4494-90e3-e837946c85d2' class='xr-var-data-in' type='checkbox'><label for='data-eb4751a0-c5e4-4494-90e3-e837946c85d2' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array(&#x27;2013-01-01T00:00:00.000000000&#x27;, dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-730f1c99-73e5-42de-ab5e-baf768b27008' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-730f1c99-73e5-42de-ab5e-baf768b27008' class='xr-section-summary'  title='Expand/collapse section'>Indexes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'></ul></div></li><li class='xr-section-item'><input id='section-5fdb30f1-5c9a-4d86-9efe-dd1f94991f32' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-5fdb30f1-5c9a-4d86-9efe-dd1f94991f32' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<p>Finally we get some output! Let’s check that this is right</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
    <span class="n">newlat</span><span class="p">,</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">]],</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="p">)</span>
<span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interped</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>No errors are raised so it is right!</p>
</section>
<section id="vectorization-with-np-vectorize">
<h2>Vectorization with <code class="docutils literal notranslate"><span class="pre">np.vectorize</span></code><a class="headerlink" href="#vectorization-with-np-vectorize" title="Permalink to this headline">#</a></h2>
<p>Now our function currently only works on one vector of data which is not so useful given our 3D dataset.
Let’s try passing the whole dataset. We add a <code class="docutils literal notranslate"><span class="pre">print</span></code> statement so we can see what our function receives.</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp1d_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
    <span class="n">newlat</span><span class="p">,</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">]],</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="p">)</span>
<span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interped</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data: (4, 3, 25) | x: (25,) | xi: (100,)
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">air</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">newlat</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>  <span class="c1"># list with one entry per arg</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">]],</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">interped</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:1204,</span> in <span class="ni">apply_ufunc</span><span class="nt">(func, input_core_dims, output_core_dims, exclude_dims, vectorize, join, dataset_join, dataset_fill_value, keep_attrs, kwargs, dask, output_dtypes, output_sizes, meta, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span> <span class="c1"># feed DataArray apply_variable_ufunc through apply_dataarray_vfunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1203</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1204</span>     <span class="k">return</span> <span class="n">apply_dataarray_vfunc</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span>         <span class="n">variables_vfunc</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1206</span>         <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1207</span>         <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1208</span>         <span class="n">join</span><span class="o">=</span><span class="n">join</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1209</span>         <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1210</span>         <span class="n">keep_attrs</span><span class="o">=</span><span class="n">keep_attrs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1212</span> <span class="c1"># feed Variables directly through apply_variable_ufunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:315,</span> in <span class="ni">apply_dataarray_vfunc</span><span class="nt">(func, signature, join, exclude_dims, keep_attrs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> <span class="n">result_coords</span><span class="p">,</span> <span class="n">result_indexes</span> <span class="o">=</span> <span class="n">build_output_coords_and_indexes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="n">args</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="p">,</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="n">keep_attrs</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span> <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">315</span> <span class="n">result_var</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">data_vars</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span> <span class="n">out</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="n">DataArray</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span> <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:771,</span> in <span class="ni">apply_variable_ufunc</span><span class="nt">(func, signature, exclude_dims, dask, output_dtypes, vectorize, keep_attrs, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">766</span>     <span class="k">if</span> <span class="n">vectorize</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">767</span>         <span class="n">func</span> <span class="o">=</span> <span class="n">_vectorize</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">768</span>             <span class="n">func</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">output_dtypes</span><span class="o">=</span><span class="n">output_dtypes</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span>
<span class="g g-Whitespace">    </span><span class="mi">769</span>         <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">771</span> <span class="n">result_data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">input_data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">773</span> <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">774</span>     <span class="n">result_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">result_data</span><span class="p">,)</span>

<span class="nn">Cell In[9], line 3,</span> in <span class="ni">interp1d_np</span><span class="nt">(data, x, xi)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">interp1d_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="nn">File &lt;__array_function__ internals&gt;:180,</span> in <span class="ni">interp</span><span class="nt">(*args, **kwargs)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numpy/lib/function_base.py:1594,</span> in <span class="ni">interp</span><span class="nt">(x, xp, fp, left, right, period)</span>
<span class="g g-Whitespace">   </span><span class="mi">1591</span>     <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">period</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">xp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">period</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1592</span>     <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>
<span class="ne">-&gt; </span><span class="mi">1594</span> <span class="k">return</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

<span class="ne">ValueError</span>: object too deep for desired array
</pre></div>
</div>
</div>
</div>
<p>That’s a hard-to-interpret error but our <code class="docutils literal notranslate"><span class="pre">print</span></code> call helpfully printed the shapes of the input data:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>data: (10, 53, 25) | x: (25,) | xi: (100,)
</pre></div>
</div>
<p>We see that <code class="docutils literal notranslate"><span class="pre">air</span></code> has been passed as a 3D numpy array which is not what <code class="docutils literal notranslate"><span class="pre">np.interp</span></code> expects. Instead we want loop over all combinations of <code class="docutils literal notranslate"><span class="pre">lon</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code>; and apply our function to each corresponding vector of data along <code class="docutils literal notranslate"><span class="pre">lat</span></code>.
<code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> makes this easy by specifying <code class="docutils literal notranslate"><span class="pre">vectorize=True</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vectorize : bool, optional
    If True, then assume ``func`` only takes arrays defined over core
    dimensions as input and vectorize it automatically with
    :py:func:`numpy.vectorize`. This option exists for convenience, but is
    almost always slower than supplying a pre-vectorized function.
    Using this option requires NumPy version 1.12 or newer.
</pre></div>
</div>
<p>Also see the documentation for <code class="docutils literal notranslate"><span class="pre">np.vectorize</span></code>: <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.vectorize.html">https://numpy.org/doc/stable/reference/generated/numpy.vectorize.html</a>. Most importantly</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The vectorize function is provided primarily for convenience, not for performance. 
The implementation is essentially a for loop.
</pre></div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp1d_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">newlat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">]],</span>  <span class="c1"># returned data has one dimension</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># loop over non-core dims</span>
<span class="p">)</span>
<span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">interped</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">air</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>  <span class="c1"># as above</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">newlat</span><span class="p">,</span>  <span class="c1"># as above</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[]],</span>  <span class="c1"># list with one entry per arg</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">]],</span>  <span class="c1"># returned data has one dimension</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be set!</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># loop over non-core dims</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">interped</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:1204,</span> in <span class="ni">apply_ufunc</span><span class="nt">(func, input_core_dims, output_core_dims, exclude_dims, vectorize, join, dataset_join, dataset_fill_value, keep_attrs, kwargs, dask, output_dtypes, output_sizes, meta, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span> <span class="c1"># feed DataArray apply_variable_ufunc through apply_dataarray_vfunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1203</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1204</span>     <span class="k">return</span> <span class="n">apply_dataarray_vfunc</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span>         <span class="n">variables_vfunc</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1206</span>         <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1207</span>         <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1208</span>         <span class="n">join</span><span class="o">=</span><span class="n">join</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1209</span>         <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1210</span>         <span class="n">keep_attrs</span><span class="o">=</span><span class="n">keep_attrs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1212</span> <span class="c1"># feed Variables directly through apply_variable_ufunc</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span> <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:315,</span> in <span class="ni">apply_dataarray_vfunc</span><span class="nt">(func, signature, join, exclude_dims, keep_attrs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> <span class="n">result_coords</span><span class="p">,</span> <span class="n">result_indexes</span> <span class="o">=</span> <span class="n">build_output_coords_and_indexes</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="n">args</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="p">,</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="n">keep_attrs</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span> <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">315</span> <span class="n">result_var</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">data_vars</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span> <span class="n">out</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataArray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="n">DataArray</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span> <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/xarray/core/computation.py:771,</span> in <span class="ni">apply_variable_ufunc</span><span class="nt">(func, signature, exclude_dims, dask, output_dtypes, vectorize, keep_attrs, dask_gufunc_kwargs, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">766</span>     <span class="k">if</span> <span class="n">vectorize</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">767</span>         <span class="n">func</span> <span class="o">=</span> <span class="n">_vectorize</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">768</span>             <span class="n">func</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">output_dtypes</span><span class="o">=</span><span class="n">output_dtypes</span><span class="p">,</span> <span class="n">exclude_dims</span><span class="o">=</span><span class="n">exclude_dims</span>
<span class="g g-Whitespace">    </span><span class="mi">769</span>         <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">771</span> <span class="n">result_data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">input_data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">773</span> <span class="k">if</span> <span class="n">signature</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">774</span>     <span class="n">result_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">result_data</span><span class="p">,)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numpy/lib/function_base.py:2328,</span> in <span class="ni">vectorize.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2325</span>     <span class="n">vargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">2326</span>     <span class="n">vargs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">kwargs</span><span class="p">[</span><span class="n">_n</span><span class="p">]</span> <span class="k">for</span> <span class="n">_n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">])</span>
<span class="ne">-&gt; </span><span class="mi">2328</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorize_call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">vargs</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numpy/lib/function_base.py:2402,</span> in <span class="ni">vectorize._vectorize_call</span><span class="nt">(self, func, args)</span>
<span class="g g-Whitespace">   </span><span class="mi">2400</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Vectorized call to `func` over positional `args`.&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">2401</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2402</span>     <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorize_call_with_signature</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2403</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2404</span>     <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numpy/lib/function_base.py:2430,</span> in <span class="ni">vectorize._vectorize_call_with_signature</span><span class="nt">(self, func, args)</span>
<span class="g g-Whitespace">   </span><span class="mi">2425</span>     <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;wrong number of positional arguments: &#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">2426</span>                     <span class="s1">&#39;expected </span><span class="si">%r</span><span class="s1">, got </span><span class="si">%r</span><span class="s1">&#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">2427</span>                     <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_core_dims</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
<span class="g g-Whitespace">   </span><span class="mi">2428</span> <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2430</span> <span class="n">broadcast_shape</span><span class="p">,</span> <span class="n">dim_sizes</span> <span class="o">=</span> <span class="n">_parse_input_dimensions</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2431</span>     <span class="n">args</span><span class="p">,</span> <span class="n">input_core_dims</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2432</span> <span class="n">input_shapes</span> <span class="o">=</span> <span class="n">_calculate_shapes</span><span class="p">(</span><span class="n">broadcast_shape</span><span class="p">,</span> <span class="n">dim_sizes</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2433</span>                                  <span class="n">input_core_dims</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2434</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2435</span>         <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">input_shapes</span><span class="p">)]</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numpy/lib/function_base.py:2090,</span> in <span class="ni">_parse_input_dimensions</span><span class="nt">(args, input_core_dims)</span>
<span class="g g-Whitespace">   </span><span class="mi">2088</span>     <span class="n">dummy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">ndim</span><span class="p">])</span>
<span class="g g-Whitespace">   </span><span class="mi">2089</span>     <span class="n">broadcast_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dummy_array</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2090</span> <span class="n">broadcast_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">_broadcast_shape</span><span class="p">(</span><span class="o">*</span><span class="n">broadcast_args</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2091</span> <span class="k">return</span> <span class="n">broadcast_shape</span><span class="p">,</span> <span class="n">dim_sizes</span>

<span class="nn">File /usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numpy/lib/stride_tricks.py:422,</span> in <span class="ni">_broadcast_shape</span><span class="nt">(*args)</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Returns the shape of the arrays that would result from broadcasting the</span>
<span class="g g-Whitespace">    </span><span class="mi">418</span><span class="sd"> supplied arrays against each other.</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span> <span class="c1"># use the old-iterator because np.nditer does not handle size 0 arrays</span>
<span class="g g-Whitespace">    </span><span class="mi">421</span> <span class="c1"># consistently</span>
<span class="ne">--&gt; </span><span class="mi">422</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[:</span><span class="mi">32</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">423</span> <span class="c1"># unfortunately, it cannot handle 32 or more arguments directly</span>
<span class="g g-Whitespace">    </span><span class="mi">424</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="mi">31</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span>     <span class="c1"># ironically, np.broadcast does not properly handle np.broadcast</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span>     <span class="c1"># objects (it treats them as scalars)</span>
<span class="g g-Whitespace">    </span><span class="mi">427</span>     <span class="c1"># use broadcasting to avoid allocating the full array</span>

<span class="ne">ValueError</span>: shape mismatch: objects cannot be broadcast to a single shape.  Mismatch is between arg 0 with shape (4, 3) and arg 2 with shape (100,).
</pre></div>
</div>
</div>
</div>
<p>This unfortunately is another cryptic error from numpy.</p>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">newlat</span></code> is not an xarray object. Let’s add a dimension name <code class="docutils literal notranslate"><span class="pre">new_lat</span></code> and modify the call. Note this cannot be <code class="docutils literal notranslate"><span class="pre">lat</span></code> because xarray expects dimensions to be the same size (or broadcastable) among all inputs. <code class="docutils literal notranslate"><span class="pre">output_core_dims</span></code> needs to be modified appropriately. We’ll manually rename <code class="docutils literal notranslate"><span class="pre">new_lat</span></code> back to <code class="docutils literal notranslate"><span class="pre">lat</span></code> for easy checking.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp1d_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">newlat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;new_lat&quot;</span><span class="p">]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;new_lat&quot;</span><span class="p">]],</span>  <span class="c1"># returned data has one dimension</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be a set!</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># loop over non-core dims</span>
<span class="p">)</span>
<span class="n">interped</span> <span class="o">=</span> <span class="n">interped</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;new_lat&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span>
<span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
    <span class="n">expected</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">interped</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span> <span class="n">interped</span>  <span class="c1"># order of dims is different</span>
<span class="p">)</span>
<span class="n">interped</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
</pre></div>
</div>
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (time: 4, lon: 3, lat: 100)&gt;
array([[[296.29000854, 296.19545954, 296.10091053, ..., 242.46059857,
         241.83029776, 241.19999695],
        [296.79000854, 296.64697173, 296.50393492, ..., 243.46969697,
         242.98484848, 242.5       ],
        [297.1000061 , 297.02485518, 296.94970426, ..., 244.0818167 ,
         243.79090835, 243.5       ]],

       [[296.29000854, 296.26818385, 296.24635916, ..., 242.82726357,
         242.46362721, 242.09999084],
        [297.19998169, 297.07876957, 296.95755745, ..., 243.37878187,
         243.03938941, 242.69999695],
        [297.3999939 , 297.25211866, 297.10424342, ..., 243.63332714,
         243.36665899, 243.09999084]],

       [[296.3999939 , 296.35150609, 296.30301828, ..., 243.41514079,
         242.85756429, 242.29998779],
        [296.29000854, 296.34091556, 296.39182258, ..., 243.26181631,
         242.73090663, 242.19999695],
        [296.3999939 , 296.37333078, 296.34666767, ..., 243.12423614,
         242.71211196, 242.29998779]],

       [[297.5       , 297.37878788, 297.25757576, ..., 244.02817559,
         242.95908749, 241.88999939],
        [297.69998169, 297.65150128, 297.60302087, ..., 243.49695749,
         242.64847264, 241.79998779],
        [297.5       , 297.40303178, 297.30606357, ..., 242.9636286 ,
         242.38180819, 241.79998779]]])
Coordinates:
  * lon      (lon) float32 200.0 202.5 205.0
  * time     (time) datetime64[ns] 2013-01-01 ... 2013-01-01T18:00:00
  * lat      (lat) float64 15.0 15.61 16.21 16.82 ... 73.18 73.79 74.39 75.0</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 4</li><li><span class='xr-has-index'>lon</span>: 3</li><li><span class='xr-has-index'>lat</span>: 100</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-928fcdd8-91ef-422e-87b3-5b089d43a8d0' class='xr-array-in' type='checkbox' checked><label for='section-928fcdd8-91ef-422e-87b3-5b089d43a8d0' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>296.3 296.2 296.1 296.0 295.9 296.0 ... 244.1 243.5 243.0 242.4 241.8</span></div><div class='xr-array-data'><pre>array([[[296.29000854, 296.19545954, 296.10091053, ..., 242.46059857,
         241.83029776, 241.19999695],
        [296.79000854, 296.64697173, 296.50393492, ..., 243.46969697,
         242.98484848, 242.5       ],
        [297.1000061 , 297.02485518, 296.94970426, ..., 244.0818167 ,
         243.79090835, 243.5       ]],

       [[296.29000854, 296.26818385, 296.24635916, ..., 242.82726357,
         242.46362721, 242.09999084],
        [297.19998169, 297.07876957, 296.95755745, ..., 243.37878187,
         243.03938941, 242.69999695],
        [297.3999939 , 297.25211866, 297.10424342, ..., 243.63332714,
         243.36665899, 243.09999084]],

       [[296.3999939 , 296.35150609, 296.30301828, ..., 243.41514079,
         242.85756429, 242.29998779],
        [296.29000854, 296.34091556, 296.39182258, ..., 243.26181631,
         242.73090663, 242.19999695],
        [296.3999939 , 296.37333078, 296.34666767, ..., 243.12423614,
         242.71211196, 242.29998779]],

       [[297.5       , 297.37878788, 297.25757576, ..., 244.02817559,
         242.95908749, 241.88999939],
        [297.69998169, 297.65150128, 297.60302087, ..., 243.49695749,
         242.64847264, 241.79998779],
        [297.5       , 297.40303178, 297.30606357, ..., 242.9636286 ,
         242.38180819, 241.79998779]]])</pre></div></div></li><li class='xr-section-item'><input id='section-5d35239a-69aa-4f3d-a29e-02ce8f55e738' class='xr-section-summary-in' type='checkbox'  checked><label for='section-5d35239a-69aa-4f3d-a29e-02ce8f55e738' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lon</span></div><div class='xr-var-dims'>(lon)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>200.0 202.5 205.0</div><input id='attrs-f9c6b0cb-7602-4d52-a746-16b781e7c2b4' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-f9c6b0cb-7602-4d52-a746-16b781e7c2b4' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a06ea08b-3529-4f0e-be4d-5a86b8ae7d76' class='xr-var-data-in' type='checkbox'><label for='data-a06ea08b-3529-4f0e-be4d-5a86b8ae7d76' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([200. , 202.5, 205. ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2013-01-01 ... 2013-01-01T18:00:00</div><input id='attrs-e6566006-a44a-4deb-930f-28bdc37692dc' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e6566006-a44a-4deb-930f-28bdc37692dc' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-24d6a1a1-44eb-4d16-83aa-c2dd187908f9' class='xr-var-data-in' type='checkbox'><label for='data-24d6a1a1-44eb-4d16-83aa-c2dd187908f9' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;2013-01-01T00:00:00.000000000&#x27;, &#x27;2013-01-01T06:00:00.000000000&#x27;,
       &#x27;2013-01-01T12:00:00.000000000&#x27;, &#x27;2013-01-01T18:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lat</span></div><div class='xr-var-dims'>(lat)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>15.0 15.61 16.21 ... 74.39 75.0</div><input id='attrs-806e72a5-76a4-4dc2-917b-2315731cd332' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-806e72a5-76a4-4dc2-917b-2315731cd332' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-55a11792-1a1d-4c1f-ae9c-75b3e306fb19' class='xr-var-data-in' type='checkbox'><label for='data-55a11792-1a1d-4c1f-ae9c-75b3e306fb19' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([15.      , 15.606061, 16.212121, 16.818182, 17.424242, 18.030303,
       18.636364, 19.242424, 19.848485, 20.454545, 21.060606, 21.666667,
       22.272727, 22.878788, 23.484848, 24.090909, 24.69697 , 25.30303 ,
       25.909091, 26.515152, 27.121212, 27.727273, 28.333333, 28.939394,
       29.545455, 30.151515, 30.757576, 31.363636, 31.969697, 32.575758,
       33.181818, 33.787879, 34.393939, 35.      , 35.606061, 36.212121,
       36.818182, 37.424242, 38.030303, 38.636364, 39.242424, 39.848485,
       40.454545, 41.060606, 41.666667, 42.272727, 42.878788, 43.484848,
       44.090909, 44.69697 , 45.30303 , 45.909091, 46.515152, 47.121212,
       47.727273, 48.333333, 48.939394, 49.545455, 50.151515, 50.757576,
       51.363636, 51.969697, 52.575758, 53.181818, 53.787879, 54.393939,
       55.      , 55.606061, 56.212121, 56.818182, 57.424242, 58.030303,
       58.636364, 59.242424, 59.848485, 60.454545, 61.060606, 61.666667,
       62.272727, 62.878788, 63.484848, 64.090909, 64.69697 , 65.30303 ,
       65.909091, 66.515152, 67.121212, 67.727273, 68.333333, 68.939394,
       69.545455, 70.151515, 70.757576, 71.363636, 71.969697, 72.575758,
       73.181818, 73.787879, 74.393939, 75.      ])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-5f064781-465c-40ac-881b-e44d18094e95' class='xr-section-summary-in' type='checkbox'  ><label for='section-5f064781-465c-40ac-881b-e44d18094e95' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>lon</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-51b22447-d160-459a-b0b6-69d70b7a6cb7' class='xr-index-data-in' type='checkbox'/><label for='index-51b22447-d160-459a-b0b6-69d70b7a6cb7' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([200.0, 202.5, 205.0], dtype=&#x27;float64&#x27;, name=&#x27;lon&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-c894db3e-6e03-4351-aa88-0c12c9be9d05' class='xr-index-data-in' type='checkbox'/><label for='index-c894db3e-6e03-4351-aa88-0c12c9be9d05' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;2013-01-01 00:00:00&#x27;, &#x27;2013-01-01 06:00:00&#x27;,
               &#x27;2013-01-01 12:00:00&#x27;, &#x27;2013-01-01 18:00:00&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, freq=None))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>lat</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-94fbf08f-b4e0-423f-90d9-698e5b69a65d' class='xr-index-data-in' type='checkbox'/><label for='index-94fbf08f-b4e0-423f-90d9-698e5b69a65d' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([              15.0, 15.606060606060606,  16.21212121212121,
               16.81818181818182, 17.424242424242426,  18.03030303030303,
              18.636363636363637, 19.242424242424242, 19.848484848484848,
              20.454545454545453, 21.060606060606062, 21.666666666666668,
              22.272727272727273,  22.87878787878788, 23.484848484848484,
              24.090909090909093, 24.696969696969695, 25.303030303030305,
               25.90909090909091, 26.515151515151516,  27.12121212121212,
              27.727272727272727, 28.333333333333336, 28.939393939393938,
              29.545454545454547, 30.151515151515152, 30.757575757575758,
              31.363636363636363,  31.96969696969697,  32.57575757575758,
               33.18181818181819,  33.78787878787879,  34.39393939393939,
                            35.0,  35.60606060606061,  36.21212121212121,
               36.81818181818182,  37.42424242424242,  38.03030303030303,
               38.63636363636364,  39.24242424242424, 39.848484848484844,
               40.45454545454545,  41.06060606060606,  41.66666666666667,
               42.27272727272727, 42.878787878787875, 43.484848484848484,
               44.09090909090909,   44.6969696969697, 45.303030303030305,
               45.90909090909091, 46.515151515151516, 47.121212121212125,
               47.72727272727273, 48.333333333333336,  48.93939393939394,
               49.54545454545455, 50.151515151515156,  50.75757575757576,
               51.36363636363637,  51.96969696969697,  52.57575757575758,
               53.18181818181818,  53.78787878787879,   54.3939393939394,
                            55.0,  55.60606060606061,  56.21212121212121,
               56.81818181818182,  57.42424242424242,  58.03030303030303,
               58.63636363636364,  59.24242424242424,  59.84848484848485,
               60.45454545454545,  61.06060606060606,  61.66666666666667,
               62.27272727272727,  62.87878787878788, 63.484848484848484,
                64.0909090909091,  64.69696969696969,  65.30303030303031,
                65.9090909090909,  66.51515151515152,  67.12121212121212,
               67.72727272727272,  68.33333333333334,  68.93939393939394,
               69.54545454545455,  70.15151515151516,  70.75757575757575,
               71.36363636363637,  71.96969696969697,  72.57575757575758,
               73.18181818181819,  73.78787878787878,   74.3939393939394,
                            75.0],
             dtype=&#x27;float64&#x27;, name=&#x27;lat&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-3509d272-7df9-4c9e-8229-51e3923f969c' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-3509d272-7df9-4c9e-8229-51e3923f969c' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<p>Notice that the printed input shapes are all 1D and correspond to one vector along the <code class="docutils literal notranslate"><span class="pre">lat</span></code> dimension.</p>
<p>The result is now an xarray object with coordinate values copied over from <code class="docutils literal notranslate"><span class="pre">data</span></code>. This is why <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> is so convenient; it takes care of a lot of boilerplate necessary to apply functions that consume and produce numpy arrays to xarray objects.</p>
<p>One final point: <code class="docutils literal notranslate"><span class="pre">lat</span></code> is now the <em>last</em> dimension in <code class="docutils literal notranslate"><span class="pre">interped</span></code>. This is a “property” of core dimensions: they are moved to the end before being sent to <code class="docutils literal notranslate"><span class="pre">interp1d_np</span></code> as was noted in the docstring for <code class="docutils literal notranslate"><span class="pre">input_core_dims</span></code></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Core dimensions are automatically moved to the last axes of input
    variables before applying ``func``, which facilitates using NumPy style
    generalized ufuncs [2]_.
</pre></div>
</div>
</section>
<section id="parallelization-with-dask">
<h2>Parallelization with dask<a class="headerlink" href="#parallelization-with-dask" title="Permalink to this headline">#</a></h2>
<p>So far our function can only handle numpy arrays. A real benefit of <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> is the ability to easily parallelize over dask chunks <em>when needed</em>.</p>
<p>We want to apply this function in a vectorized fashion over each chunk of the dask array. This is possible using dask’s <code class="docutils literal notranslate"><span class="pre">blockwise</span></code>, <code class="docutils literal notranslate"><span class="pre">map_blocks</span></code>, or <code class="docutils literal notranslate"><span class="pre">apply_gufunc</span></code>. Xarray’s <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> wraps dask’s <code class="docutils literal notranslate"><span class="pre">apply_gufunc</span></code> and asking it to map the function over chunks using <code class="docutils literal notranslate"><span class="pre">apply_gufunc</span></code> is as simple as specifying <code class="docutils literal notranslate"><span class="pre">dask=&quot;parallelized&quot;</span></code>. With this level of flexibility we need to provide dask with some extra information:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">output_dtypes</span></code>: dtypes of all returned objects, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_sizes</span></code>: lengths of any new dimensions.</p></li>
</ol>
<p>Here we need to specify <code class="docutils literal notranslate"><span class="pre">output_dtypes</span></code> since <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code> can infer the size of the new dimension <code class="docutils literal notranslate"><span class="pre">new_lat</span></code> from the argument corresponding to the third element in <code class="docutils literal notranslate"><span class="pre">input_core_dims</span></code>. Here I choose the chunk sizes to illustrate that <code class="docutils literal notranslate"><span class="pre">np.vectorize</span></code> is still applied so that our function receives 1D vectors even though the blocks are 3D.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp1d_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | xi: </span><span class="si">{</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">newlat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;new_lat&quot;</span><span class="p">]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;new_lat&quot;</span><span class="p">]],</span>  <span class="c1"># returned data has one dimension</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be a set!</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># loop over non-core dims</span>
    <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
    <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">air</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>  <span class="c1"># one per output</span>
<span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;new_lat&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span>
<span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">interped</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span> <span class="n">interped</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
data: (25,) | x: (25,) | xi: (100,)
</pre></div>
</div>
</div>
</div>
<p>Yay! our function is receiving 1D vectors, so we’ve successfully parallelized applying a 1D function over a block. If you have a distributed dashboard up, you should see computes happening as equality is checked.</p>
</section>
<section id="high-performance-vectorization-gufuncs-numba-guvectorize">
<h2>High performance vectorization: gufuncs, numba &amp; guvectorize<a class="headerlink" href="#high-performance-vectorization-gufuncs-numba-guvectorize" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">np.vectorize</span></code> is a very convenient function but is unfortunately slow. It is only marginally faster than writing a for loop in Python and looping. A common way to get around this is to write a base interpolation function that can handle nD arrays in a compiled language like Fortran and then pass that to <code class="docutils literal notranslate"><span class="pre">apply_ufunc</span></code>.</p>
<p>Another option is to use the numba package which provides a very convenient <code class="docutils literal notranslate"><span class="pre">guvectorize</span></code> decorator: <a class="reference external" href="https://numba.pydata.org/numba-doc/latest/user/vectorize.html#the-guvectorize-decorator">https://numba.pydata.org/numba-doc/latest/user/vectorize.html#the-guvectorize-decorator</a></p>
<p>Any decorated function gets compiled and will loop over any non-core dimension in parallel when necessary. We need to specify some extra information:</p>
<ol class="simple">
<li><p>Our function cannot return a variable any more. Instead it must receive a variable (the last argument) whose contents the function will modify. So we change from <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">interp1d_np(data,</span> <span class="pre">x,</span> <span class="pre">xi)</span></code> to <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">interp1d_np_gufunc(data,</span> <span class="pre">x,</span> <span class="pre">xi,</span> <span class="pre">out)</span></code>. Our computed results must be assigned to <code class="docutils literal notranslate"><span class="pre">out</span></code>. All values of <code class="docutils literal notranslate"><span class="pre">out</span></code> must be assigned explicitly.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">guvectorize</span></code> needs to know the dtypes of the input and output. This is specified in string form as the first argument. Each element of the tuple corresponds to each argument of the function. In this case, we specify <code class="docutils literal notranslate"><span class="pre">float64</span></code> for all inputs and outputs: <code class="docutils literal notranslate"><span class="pre">&quot;(float64[:],</span> <span class="pre">float64[:],</span> <span class="pre">float64[:],</span> <span class="pre">float64[:])&quot;</span></code> corresponding to <code class="docutils literal notranslate"><span class="pre">data,</span> <span class="pre">x,</span> <span class="pre">xi,</span> <span class="pre">out</span></code></p></li>
<li><p>Now we need to tell numba the size of the dimensions the function takes as inputs and returns as output i.e. core dimensions. This is done in symbolic form i.e. <code class="docutils literal notranslate"><span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">x</span></code> are vectors of the same length, say <code class="docutils literal notranslate"><span class="pre">n</span></code>; <code class="docutils literal notranslate"><span class="pre">xi</span></code> and the output <code class="docutils literal notranslate"><span class="pre">out</span></code> have a different length, say <code class="docutils literal notranslate"><span class="pre">m</span></code>. So the second argument is (again as a string)
<code class="docutils literal notranslate"><span class="pre">&quot;(n),</span> <span class="pre">(n),</span> <span class="pre">(m)</span> <span class="pre">-&gt;</span> <span class="pre">(m).&quot;</span></code> corresponding again to <code class="docutils literal notranslate"><span class="pre">data,</span> <span class="pre">x,</span> <span class="pre">xi,</span> <span class="pre">out</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">guvectorize</span>


<span class="nd">@guvectorize</span><span class="p">(</span><span class="s2">&quot;(float64[:], float64[:], float64[:], float64[:])&quot;</span><span class="p">,</span> <span class="s2">&quot;(n), (n), (m) -&gt; (m)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">interp1d_np_gufunc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="c1"># numba doesn&#39;t really like this.</span>
    <span class="c1"># seem to support fstrings so do it the old way</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; | x:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; | xi: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="c1"># gufuncs don&#39;t return data</span>
    <span class="c1"># instead you assign to a the last arg</span>
    <span class="c1"># return np.interp(xi, x, data)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_3656/409442179.py:4: NumbaWarning: 
<span class=" -Color -Color-Bold">Compilation is falling back to object mode WITHOUT looplifting enabled because Function &quot;interp1d_np_gufunc&quot; failed type inference due to: No implementation of function Function(&lt;class &#39;str&#39;&gt;) found for signature:</span>
<span class=" -Color -Color-Bold"> </span>
<span class=" -Color -Color-Bold"> &gt;&gt;&gt; str(UniTuple(int64 x 1))</span>
<span class=" -Color -Color-Bold"> </span>
<span class=" -Color -Color-Bold">There are 10 candidate implementations:</span>
<span class=" -Color -Color-Bold">    - Of which 10 did not match due to:</span>
<span class=" -Color -Color-Bold">    Overload of function &#39;str&#39;: File: &lt;numerous&gt;: Line N/A.</span>
<span class=" -Color -Color-Bold">      With argument(s): &#39;(UniTuple(int64 x 1))&#39;:</span>
<span class=" -Color -Color-Bold">     No match.</span>

<span class=" -Color -Color-Bold">During: resolving callee type: Function(&lt;class &#39;str&#39;&gt;)</span>
<span class=" -Color -Color-Bold">During: typing of call at /tmp/ipykernel_3656/409442179.py (8)</span>


<span class=" -Color -Color-Bold">File &quot;../../../../../../../tmp/ipykernel_3656/409442179.py&quot;, line 8:</span>
<span class=" -Color -Color-Bold">&lt;source missing, REPL/exec in use?&gt;</span>

  @guvectorize(&quot;(float64[:], float64[:], float64[:], float64[:])&quot;, &quot;(n), (n), (m) -&gt; (m)&quot;)
/usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numba/core/object_mode_passes.py:151: NumbaWarning: <span class=" -Color -Color-Bold">Function &quot;interp1d_np_gufunc&quot; was compiled in object mode without forceobj=True.</span>

<span class=" -Color -Color-Bold">File &quot;../../../../../../../tmp/ipykernel_3656/409442179.py&quot;, line 4:</span>
<span class=" -Color -Color-Bold">&lt;source missing, REPL/exec in use?&gt;</span>

  warnings.warn(errors.NumbaWarning(warn_msg,
/usr/share/miniconda3/envs/xarray-tutorial/lib/python3.10/site-packages/numba/core/object_mode_passes.py:161: NumbaDeprecationWarning: 
<span class=" -Color -Color-Bold">Fall-back from the nopython compilation path to the object mode compilation path has been detected, this is deprecated behaviour.</span>

<span class=" -Color -Color-Bold">For more information visit https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit</span>

<span class=" -Color -Color-Bold">File &quot;../../../../../../../tmp/ipykernel_3656/409442179.py&quot;, line 4:</span>
<span class=" -Color -Color-Bold">&lt;source missing, REPL/exec in use?&gt;</span>

  warnings.warn(errors.NumbaDeprecationWarning(msg,
</pre></div>
</div>
</div>
</div>
<p>The warnings are about object-mode compilation relating to the <code class="docutils literal notranslate"><span class="pre">print</span></code> statement. This means we don’t get much speed up: <a class="reference external" href="https://numba.pydata.org/numba-doc/latest/user/performance-tips.html#no-python-mode-vs-object-mode">https://numba.pydata.org/numba-doc/latest/user/performance-tips.html#no-python-mode-vs-object-mode</a>. We’ll keep the <code class="docutils literal notranslate"><span class="pre">print</span></code> statement temporarily to make sure that <code class="docutils literal notranslate"><span class="pre">guvectorize</span></code> acts like we want it to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">interp1d_np_gufunc</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">air</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}),</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">air</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">newlat</span><span class="p">,</span>  <span class="c1"># as above</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;new_lat&quot;</span><span class="p">]],</span>  <span class="c1"># list with one entry per arg</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;new_lat&quot;</span><span class="p">]],</span>  <span class="c1"># returned data has one dimension</span>
    <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="s2">&quot;lat&quot;</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be a set!</span>
    <span class="c1"># vectorize=True,  # not needed since numba takes care of vectorizing</span>
    <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
    <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">air</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>  <span class="c1"># one per output</span>
<span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;new_lat&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span>
<span class="n">interped</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlat</span>  <span class="c1"># need to add this manually</span>
<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">interped</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span> <span class="n">interped</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
data: (25,) | x:(25,) | xi: (100,)
</pre></div>
</div>
</div>
</div>
<p>Yay! Our function is receiving 1D vectors and is working automatically with dask arrays. Finally let’s comment out the print line and wrap everything up in a nice reusable function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">guvectorize</span>


<span class="nd">@guvectorize</span><span class="p">(</span>
    <span class="s2">&quot;(float64[:], float64[:], float64[:], float64[:])&quot;</span><span class="p">,</span>
    <span class="s2">&quot;(n), (n), (m) -&gt; (m)&quot;</span><span class="p">,</span>
    <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">interp1d_np_gufunc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xr_interp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">newdim</span><span class="p">):</span>
    <span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">interp1d_np_gufunc</span><span class="p">,</span>  <span class="c1"># first the function</span>
        <span class="n">data</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
        <span class="n">data</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>  <span class="c1"># as above</span>
        <span class="n">newdim</span><span class="p">,</span>  <span class="c1"># as above</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">dim</span><span class="p">],</span> <span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;__newdim__&quot;</span><span class="p">]],</span>  <span class="c1"># list with one entry per arg</span>
        <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;__newdim__&quot;</span><span class="p">]],</span>  <span class="c1"># returned data has one dimension</span>
        <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="n">dim</span><span class="p">,)),</span>  <span class="c1"># dimensions allowed to change size. Must be a set!</span>
        <span class="c1"># vectorize=True,  # not needed since numba takes care of vectorizing</span>
        <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
        <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">],</span>  <span class="c1"># one per output; could also be float or np.dtype(&quot;float64&quot;)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;__newdim__&quot;</span><span class="p">:</span> <span class="n">dim</span><span class="p">})</span>
    <span class="n">interped</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">newdim</span>  <span class="c1"># need to add this manually</span>

    <span class="k">return</span> <span class="n">interped</span>


<span class="n">xr</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
    <span class="n">expected</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">interped</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span>
    <span class="n">xr_interp</span><span class="p">(</span><span class="n">air</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}),</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="n">newlat</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This technique is generalizable to any 1D function.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./advanced/apply_ufunc"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="simple_dask_apply_ufunc.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Handling dask arrays</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../map_blocks/map_blocks.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">map_blocks</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Xarray Community<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>